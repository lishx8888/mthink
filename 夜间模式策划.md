# 夜间模式策划

## 项目分析

### 1. 项目结构

- **主要文件**：index.html, style.css, script.js
- **样式面板**：位于右侧，包含文件控制、节点控制、颜色选择、形状选择、字体设置等
- **图标系统**：使用Font Awesome图标
- **响应式设计**：适配不同屏幕尺寸（PC端、手机端、低分辨率电脑）

### 2. 当前颜色方案

- **默认背景色**：#f5f5f5（浅灰色）
- **默认画布背景**：白色
- **默认样式面板背景**：#f0f0f0（浅灰色）
- **默认文本颜色**：#333, #555（深灰色）
- **默认按钮背景**：#444（深灰色）
- **默认边框颜色**：#ddd, #eee（浅灰色）
- **默认颜色调色板**：白色背景，黑色边框
- **用户自定义设置**：节点颜色、文字颜色、边框颜色、线条颜色等（保存在JSON中）

### 3. 夜间模式需求

- **仅修改默认UI元素**：将浅色背景改为深色背景，减少夜间使用时的屏幕亮度
- **不影响用户自定义设置**：节点颜色、文字颜色、边框颜色、线条颜色等用户在边栏中设置的内容保持不变
- **调整UI文本颜色**：确保在深色背景下的可读性
- **调整UI元素颜色**：按钮、边框等UI元素的颜色，保持视觉一致性
- **添加主题切换开关**：方便用户在浅色和深色模式之间切换
- **确保功能正常**：只是UI视觉效果改变，不影响任何功能

## 实施方案

### 1. 颜色方案设计

#### 夜间模式颜色表（仅影响默认UI元素）

| 元素                                 | 白天模式                 | 夜间模式              | 说明                       |
| ------------------------------------ | ------------------------ | --------------------- | -------------------------- |
| 页面背景                             | #f5f5f5                  | #1a1a1a               | 深色背景，减少屏幕亮度     |
| 画布背景                             | #ffffff                  | #2d2d2d               | 深色画布，与整体风格一致   |
| 样式面板背景                         | #f0f0f0                  | #252525               | 深色面板，与整体风格一致   |
| UI主文本                             | #333333                  | #e0e0e0               | 浅色文本，确保可读性       |
| UI次要文本                           | #555555                  | #b0b0b0               | 稍暗的文本，用于标签等     |
| 按钮背景                             | #444444                  | #3a3a3a               | 深色按钮，与整体风格一致   |
| 按钮悬停                             | #555555                  | #4a4a4a               | 按钮悬停效果               |
| 按钮激活                             | #666666                  | #5a5a5a               | 按钮激活效果               |
| UI边框                               | #dddddd                  | #444444               | 深色边框，与整体风格一致   |
| 分隔线                               | #999999                  | #555555               | 深色分隔线，保持视觉分隔   |
| 颜色调色板背景                       | #ffffff                  | #333333               | 深色调色板背景             |
| 颜色调色板边框                       | #dddddd                  | #555555               | 深色调色板边框             |
| 导航框（缩略图）背景                 | rgba(255, 255, 255, 0.9) | rgba(45, 45, 45, 0.9) | 深色导航框，与整体风格一致 |
| 导航框边框                           | #cccccc                  | #555555               | 深色边框，与整体风格一致   |
| 图标颜色                             | #ffffff                  | #ffffff               | 保持图标白色，确保可见性   |
| **用户自定义元素（保持不变）** | -                        | -                     | -                          |
| 节点颜色                             | 用户自定义               | 用户自定义            | 保持用户设置               |
| 节点文本颜色                         | 用户自定义               | 用户自定义            | 保持用户设置               |
| 边框颜色                             | 用户自定义               | 用户自定义            | 保持用户设置               |
| 连接线颜色                           | 用户自定义               | 用户自定义            | 保持用户设置               |

### 2. 技术实现

#### 2.1 CSS 变量

- 在style.css中添加CSS变量，用于存储主题颜色
- 定义白天和夜间两种主题的颜色变量
- 使用CSS变量统一管理颜色，方便主题切换

```css
/* 主题颜色变量（仅影响默认UI元素） */
:root {
  /* 白天模式（默认） */
  --bg-color: #f5f5f5;
  --canvas-bg: #ffffff;
  --panel-bg: #f0f0f0;
  --ui-text-primary: #333333;
  --ui-text-secondary: #555555;
  --button-bg: #444444;
  --button-hover: #555555;
  --button-active: #666666;
  --ui-border-color: #dddddd;
  --divider-color: #999999;
  --palette-bg: #ffffff;
  --palette-border: #dddddd;
  --thumbnail-bg: rgba(255, 255, 255, 0.9);
  --thumbnail-border: #cccccc;
}

/* 夜间模式 */
body.dark-mode {
  --bg-color: #1a1a1a;
  --canvas-bg: #2d2d2d;
  --panel-bg: #252525;
  --ui-text-primary: #e0e0e0;
  --ui-text-secondary: #b0b0b0;
  --button-bg: #3a3a3a;
  --button-hover: #4a4a4a;
  --button-active: #5a5a5a;
  --ui-border-color: #444444;
  --divider-color: #555555;
  --palette-bg: #333333;
  --palette-border: #555555;
  --thumbnail-bg: rgba(45, 45, 45, 0.9);
  --thumbnail-border: #555555;
}
```

#### 2.2 主题切换开关

- 在样式面板中添加主题切换开关
- 位置：右侧边栏的右下角，使用固定定位
- 样式：与实时布局开关相同的轨道旋钮设计
- 功能：点击切换白天/夜间模式

```html
<!-- 主题切换开关 - 固定在右侧边栏右下角 -->
<div class="theme-toggle-container" style="position: absolute; bottom: 10px; right: 10px; z-index: 100;">
  <label title="夜间模式" style="width: 50px; height: 36px; position: relative; display: inline-flex; align-items: center; justify-content: center; cursor: pointer;">
    <input type="checkbox" id="themeToggle" style="opacity: 0; width: 0; height: 0;">
    <span id="themeTrack" style="position: absolute; top: 50%; left: 0; right: 0; height: 28px; background-color: #444; border-radius: 14px; transition: .4s; transform: translateY(-50%);"></span>
    <span id="themeKnob" style="position: absolute; content: ''; top: 50%; left: 2px; width: 24px; height: 24px; background-color: white; border-radius: 50%; transition: .4s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); transform: translateY(-50%);"></span>
    <i class="fa fa-moon-o" style="position: absolute; left: 5px; color: #444; font-size: 12px;"></i>
    <i class="fa fa-sun-o" style="position: absolute; right: 5px; color: #444; font-size: 12px;"></i>
  </label>
</div>
```

#### 2.3 JavaScript 实现

- 添加主题切换逻辑
- 保存主题偏好到localStorage
- 页面加载时恢复上次选择的主题
- 处理主题切换时的动画效果

```javascript
// 主题切换逻辑
const themeToggle = document.getElementById('themeToggle');
const themeTrack = document.getElementById('themeTrack');
const themeKnob = document.getElementById('themeKnob');

// 加载保存的主题
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') {
  document.body.classList.add('dark-mode');
  themeToggle.checked = true;
  updateThemeSwitch(true);
}

// 主题切换事件监听
themeToggle.addEventListener('change', function() {
  const isDarkMode = this.checked;
  if (isDarkMode) {
    document.body.classList.add('dark-mode');
    localStorage.setItem('theme', 'dark');
  } else {
    document.body.classList.remove('dark-mode');
    localStorage.setItem('theme', 'light');
  }
  updateThemeSwitch(isDarkMode);
});

// 更新主题开关状态
function updateThemeSwitch(isDarkMode) {
  if (isDarkMode) {
    themeTrack.style.backgroundColor = '#3a3a3a';
    themeKnob.style.transform = 'translate(24px, -50%)';
  } else {
    themeTrack.style.backgroundColor = '#444';
    themeKnob.style.transform = 'translate(0, -50%)';
  }
}

// 注意：不需要更新节点文本颜色
// 节点文本颜色由用户自定义，保存在JSON中，不应被夜间模式影响
// function updateNodeTextColor() {
//   const isDarkMode = document.body.classList.contains('dark-mode');
//   const textColor = isDarkMode ? '#e0e0e0' : '#000000';
//   // 遍历所有节点，更新文本颜色
//   // 这里需要根据实际的节点创建和管理逻辑来实现
// }
```

#### 2.4 CSS 样式更新

- 使用CSS变量替换所有硬编码的颜色值
- 确保所有元素都使用CSS变量，以便主题切换时能正确更新

```css
/* 示例：使用CSS变量（仅影响UI元素） */
body {
  font-family: Arial, sans-serif;
  background-color: var(--bg-color);
  color: var(--ui-text-primary);
}

.canvas-container {
  background-color: var(--canvas-bg);
}

.style-panel {
  background-color: var(--panel-bg);
  border-left: 1px solid var(--ui-border-color);
}

.panel-button {
  background-color: var(--button-bg);
  color: white;
}

.panel-button:hover {
  background-color: var(--button-hover);
}

.panel-button:active {
  background-color: var(--button-active);
}

.color-palette {
  background-color: var(--palette-bg);
  border: 1px solid var(--palette-border);
}

.divider {
  background: linear-gradient(to right, transparent, var(--divider-color), transparent);
}

/* 导航框（缩略图）样式 */
.thumbnail-canvas {
  background-color: var(--thumbnail-bg);
  border: 1px solid var(--thumbnail-border);
}

/* 注意：节点文本颜色由用户自定义，不使用CSS变量 */
/* .node text { fill: var(--node-text); } */

/* 样式面板标签文本 */
.style-group label {
  color: var(--ui-text-secondary);
}

/* 输入框和选择框 */
.style-group input[type="number"],
.style-group select {
  border: 1px solid var(--ui-border-color);
  background-color: var(--palette-bg);
  color: var(--ui-text-primary);
}
```

### 3. 功能实现

#### 3.1 主题切换开关

- **位置**：右侧边栏的右下角，固定定位
- **图标**：月亮（夜间模式）和太阳（白天模式）图标
- **样式**：与实时布局开关相同的轨道旋钮设计
- **动画**：平滑的切换动画效果

#### 3.2 主题保存

- 使用localStorage保存用户的主题偏好（仅保存主题模式，不影响用户自定义设置）
- 页面刷新后自动恢复上次选择的主题
- 首次访问时默认为白天模式

#### 3.3 颜色调整（仅影响默认UI元素）

- **画布背景**：根据主题自动调整
- **样式面板**：根据主题自动调整
- **UI文本颜色**：根据主题自动调整
- **按钮颜色**：根据主题自动调整
- **UI边框颜色**：根据主题自动调整
- **分隔线颜色**：根据主题自动调整
- **颜色调色板**：根据主题自动调整
- **用户自定义元素**：保持不变，包括节点颜色、文字颜色、边框颜色、线条颜色等

#### 3.4 响应式支持

- 确保夜间模式在所有屏幕尺寸下都能正常显示
- 适配PC端、手机端、低分辨率电脑
- 保持响应式布局的一致性

## 实施步骤

### 1. 准备工作

- 备份当前的style.css文件
- 了解项目的颜色使用情况
- 设计夜间模式的颜色方案

### 2. CSS 变量添加

- 在style.css文件顶部添加CSS变量
- 定义白天和夜间两种主题的颜色变量

### 3. 样式更新

- 使用CSS变量替换所有硬编码的颜色值
- 确保所有元素都使用CSS变量

### 4. 主题切换开关添加

- 在index.html中添加主题切换开关
- 位置：节点控制栏中
- 样式：与实时布局开关相同

### 5. JavaScript 逻辑添加

- 添加主题切换逻辑（仅影响UI元素）
- 添加主题保存功能（仅保存主题模式）
- **注意**：不添加节点文本颜色更新功能，保持用户自定义设置

### 6. 测试与调试

- 测试主题切换功能（确保UI元素颜色正确变化）
- 测试用户自定义设置（确保节点颜色、文字颜色等不受影响）
- 测试JSON保存/加载功能（确保主题切换不会影响保存的设置）
- 测试响应式布局（确保所有屏幕尺寸下都正常）
- 测试所有功能是否正常（确保主题切换不影响任何功能）
- 调试颜色显示问题

### 7. 优化与完善

- 优化动画效果
- 完善颜色方案
- 确保代码质量

## 预期效果

### 1. 视觉效果

- **白天模式**：保持当前的浅色主题
- **夜间模式**：深色背景，浅色文本，整体风格统一
- **主题切换**：平滑的动画效果，无卡顿

### 2. 功能效果

- 所有功能正常运行
- 主题偏好自动保存
- 页面刷新后保持上次选择的主题
- 响应式布局正常

### 3. 用户体验

- 减少夜间使用时的屏幕亮度，保护眼睛
- 提供舒适的视觉体验
- 操作简单，一键切换主题
- 保持功能完整性，不影响使用

## 技术难点与解决方案

### 2. 技术难点与解决方案

#### 1. 颜色适配

- **难点**：确保所有UI元素的颜色在夜间模式下都能正确显示，特别是文本和按钮
- **解决方案**：使用CSS变量统一管理颜色，设计合理的颜色方案

#### 2. 用户自定义设置保护

- **难点**：确保夜间模式不会影响用户在边栏中设置的颜色（如节点颜色、文字颜色等）
- **解决方案**：只对UI元素使用CSS变量，用户自定义设置保持不变

#### 3. 响应式设计

- **难点**：确保夜间模式在所有屏幕尺寸下都能正常显示
- **解决方案**：使用CSS变量，确保响应式样式也能正确应用

#### 4. 性能优化

- **难点**：主题切换时避免页面卡顿
- **解决方案**：使用CSS变量和简单的类切换，避免大量DOM操作

## 总结

夜间模式是一项提升用户体验的重要功能，特别是对于经常在夜间使用思维导图的用户。通过本策划，我们将为项目添加一个美观、实用的夜间模式，同时保持功能的完整性和响应式设计的一致性。

实施后，用户可以根据自己的喜好和使用环境，自由切换白天和夜间模式，获得更好的使用体验。
