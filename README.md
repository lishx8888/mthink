# mthink

一个功能完善的思维导图工具，支持创建、编辑、保存和加载思维导图，具备强大的自动布局功能。

## 功能特性

### 核心功能
- 创建和编辑思维导图节点
- 支持节点颜色自定义
- 支持添加、删除和编辑节点内容
- 支持保存思维导图（JSON格式）
- 支持导出思维导图（SVG、PNG、Markdown格式）
- 支持导入思维导图（JSON格式）
- 响应式设计，适配不同屏幕尺寸

### 优化功能
- **节点编号系统**：为每个节点自动生成唯一编号，支持正向（1, 2, 3...）和反向（-1, -2, -3...）编号
- **智能自动布局**：基于节点编号实现稳定的自动布局，一次点击即可达到预期效果
- **坐标系统优化**：将(0,0)点从页面左上角移到页面中央，更符合使用习惯
- **节点内容与编号分离**：节点编号和文字内容独立存储，避免相互干扰
- **改进的保存/加载**：确保节点编号和文字内容在保存和导入过程中不丢失
- **水平节点间距优化**：确保正向布局中节点不重叠，保持相邻节点边的108px间距
- **文本溢出处理**：实现文本自动换行逻辑和CSS clip-path，确保文本不会超出节点框
- **端点位置固定**：编辑节点文本后，节点的端点位置保持固定
- **节点对齐优化**：使用第一个节点的端点位置作为基准，确保所有子节点左端点对齐，所有父节点右端点对齐
- **根节点位置固定**：确保根节点固定在中心(0,0)，包括编辑文本时
- **默认节点宽度**：所有节点默认宽度为400px，保持一致性
- **编辑模式优化**：编辑节点文本时，节点高度根据内容自动调整
- **多选节点样式设置**：选择多个节点时，只修改用户实际调整的样式属性，保持其他属性不变
- **连接线颜色保存**：确保连接线颜色在保存和加载过程中不丢失，保持视觉一致性
- **SVG/PNG导出优化**：确保导出的文件中文本与编辑界面保持一致的左对齐样式，避免文本变成单行显示
- **中心节点标识**：为中心节点添加isCenterNode属性，明确标识初始节点或中心节点，方便后续优化
- **撤销操作修复**：修复撤销操作后节点不立即消失、需要撤销两次的问题，确保撤销操作流畅
- **导入文件处理**：优化导入JSON文件的处理，确保即使缺少isCenterNode属性也能正确识别中心节点
- **多个中心节点处理**：当导入的文件中存在多个nodeNumber为"0"的节点时，自动处理冲突，确保只有一个中心节点
- **节点形状选择**：支持选择不同的节点形状（跑道形和圆角矩形），并在缩略图中保持一致的显示
- **双击编辑与布局冲突修复**：解决了编辑节点后双击另一个节点时的布局冲突问题，确保前一个节点的布局正确更新
- **导航缩略图优化**：确保导航缩略图中的节点框形状与主绘制区保持一致，不再默认都是跑道形状
- **分枝布局优化算法**：实现了基于分枝位置的智能布局优化，根据分枝在上级节点中的位置（上分枝、中分枝、下分枝）采取不同的布局策略
- **光标选择区域优化**：编辑模式下，将foreignObject的左边界与节点左侧边缘对齐，覆盖文字与左边框之间的空间，使用户可以在文字与左边框之间的空间点击，更容易地选择行首文字
- **编辑模式空间平衡**：确保编辑模式下的文本位置与显示模式一致，同时保持右侧输入空间与显示模式相同，避免多字或少字的问题
- **右侧栏显隐控制**：在页面右下角添加了一个90x90px的方形识别区域，当鼠标移动到该区域时，会显示一个圆形按钮，点击该按钮可以隐藏或显示右侧栏，优化了界面空间的使用
- **自动调整同步更新**：修改了文本输入过程中的自动调整逻辑，确保在文本内容变化时，foreignObject的位置和大小也会相应更新，保持左侧的额外空间，同时确保右侧有足够的输入空间

### 夜间模式优化
- **夜间模式支持**：实现了完整的夜间模式切换功能，包括主绘制区、导航窗、表单元素等所有界面元素的颜色适配
- **导航框背景颜色优化**：确保夜间模式下导航框背景色跟随主画面变化，从浅蓝色调整为更深的颜色，与主绘制区有明显区别
- **主题切换即时更新**：修复了开关夜间模式后导航窗需要点击绘制区才会变色的问题，现在主题切换会立即更新所有界面元素
- **表单元素背景色优化**：解决了夜间模式下下拉菜单和输入框白色背景太刺眼的问题，为所有表单元素添加了适合夜间模式的背景色和文字颜色
- **主题切换开关图标优化**：将主题切换开关从轨道式改为圆形按钮，两个图标叠加，通过opacity控制显示，点击切换主题时切换图标，更加直观形象
- **主题切换按钮位置优化**：将夜间模式的开关按钮移到右下角的"显隐右侧栏"按钮的上方，按钮大小与其一致，布局更加合理
- **默认节点样式优化**：设计了适合夜间模式的默认节点样式：背景色R233,G228,B195，边框无边框，形状圆角矩形，文字黑色，避免夜间模式下节点太刺眼
- **形状选择框优化**：在夜间模式下，未选中的形状框背景色改为#515151，选中时的状态改为更深的背景色，与未选中状态有明显区别
- **文字对齐选项优化**：为文字对齐选项添加了适合夜间模式的背景色，并优化了选中状态的样式，使其在夜间模式下显示适合的颜色
- **选中状态边框颜色优化**：解决了夜间模式下选中状态边框过于刺眼的问题，调整了边框颜色，使其在不同主题下都能显示适合的颜色
- **图标适配**：提供了两个SVG分别对应白天与黑夜，设置为夜间模式开关的显示，白天显示黑夜的图标，进入夜间模式后显示白天的图标

## 使用方法

### 基本操作
1. 打开 `index.html` 文件
2. 点击画布创建中心节点
3. 点击节点上的"添加子节点"按钮添加正向思维节点（右侧）
4. 点击节点上的"添加父节点"按钮添加反向思维节点（左侧）
5. 双击节点可编辑内容
6. 使用侧边栏的颜色选择器更改节点颜色
7. 使用侧边栏的节点形状选择器选择不同的节点形状（跑道形或圆角矩形）
8. 使用**保存**按钮保存思维导图（JSON格式）
9. 使用**加载**按钮加载思维导图（JSON格式）
10. 使用**导出**按钮导出思维导图为其他格式（SVG、PNG、Markdown）
11. **右侧栏显隐控制**：将鼠标移动到页面右下角的90x90px方形区域，会显示一个带有"右"字的圆形按钮，点击该按钮可以隐藏或显示右侧栏

### 自动布局功能
1. 点击"自动布局"按钮，系统会自动为所有节点分配位置
2. 自动布局会基于节点编号进行排序和定位
3. 系统会为没有编号的节点自动生成合理的编号
4. 一次点击即可达到稳定的布局效果

### 节点编号规则
- **中心节点**：编号为 "0"
- **正向思维节点**（右侧）：按层级编号为 1, 2, 3, 2.1, 2.2, 2.3, 2.2.1, 2.2.2...
- **反向思维节点**（左侧）：按层级编号为 -1, -2, -3, -2.1, -2.2, -2.3, -2.2.1, -2.2.2...
- 节点编号会在自动布局时自动生成和更新

## 技术栈

- HTML5
- CSS3
- JavaScript (ES6+)
- SVG

## 项目结构

```
mthink/
├── index.html    # 主页面
├── style.css     # 样式文件
├── script.js     # 主要逻辑
├── server.js     # 本地服务器
└── README.md     # 项目说明
```

## 开发说明

### 启动本地服务器

```bash
node server.js
```

然后在浏览器中访问 `http://localhost:8000`

### 功能实现

- **节点创建与编辑**: 支持点击创建节点，双击编辑内容
- **节点连接**: 自动绘制节点之间的连接线
- **SVG导入/导出**: 支持将思维导图导出为SVG格式，并可导入外部SVG思维导图
- **响应式设计**: 适配桌面和移动设备
- **自定义保存对话框**: 提供美观的自定义保存对话框

## 未来计划

- **思维导图合并**：实现两个思维导图的合并功能，基于isCenterNode属性识别中心节点
- **实时协作**：添加多人实时协作编辑功能
- **更多导出格式**：支持导出为PDF、Word等更多格式
- **模板系统**：提供思维导图模板，方便快速创建特定类型的思维导图
- **高级样式定制**：支持更丰富的节点样式定制，如边框样式、阴影效果等
- **搜索功能**：添加节点内容搜索功能，快速定位相关节点

## 许可证

MIT License

## 部署到Cloudflare Pages

本项目可以轻松部署到Cloudflare Pages作为静态网站，实现全球范围内的快速访问。

### 部署步骤（静态网站模式）

#### 方法一：通过GitHub/GitLab集成（推荐）
1. 将项目上传到GitHub或GitLab仓库
2. 登录Cloudflare账户，进入Cloudflare Pages
3. 点击"Create a project"
4. 选择你的GitHub/GitLab仓库
5. 配置构建设置：
   - **Framework preset**: 选择 "None"
   - **Build command**: 留空（因为不需要构建步骤）
   - **Build output directory**: 留空（使用根目录）
6. 点击"Save and Deploy"
7. 等待部署完成，获取生成的URL

#### 方法二：直接上传文件（推荐）
1. 登录Cloudflare账户，进入Cloudflare Pages
2. 点击"Create a project"
3. 选择"Direct Upload"选项
4. 上传项目文件（可以压缩为ZIP文件上传）
5. 点击"Deploy"
6. 等待部署完成，获取生成的URL

### 注意事项
- **避免Function部署**：确保项目中没有`/functions`目录，因为Cloudflare Pages会尝试部署该目录中的Function
- **纯静态网站**：本项目是纯前端应用，不需要后端Function，应作为静态网站部署
- **部署错误处理**：如果遇到"Failed to publish your Function"错误，说明Cloudflare尝试部署Function，请确保项目结构正确

### 配置优化
- **自定义域名**：可以绑定自己的域名到Cloudflare Pages
- **HTTPS**：Cloudflare自动提供HTTPS证书
- **缓存设置**：Cloudflare默认会缓存静态资源，提高加载速度
- **CORS设置**：如果需要，在Cloudflare的页面规则中配置CORS头

### 部署优势
- **全球CDN**：Cloudflare的全球CDN网络确保用户从最近的节点访问，提高加载速度
- **免费使用**：Cloudflare Pages的免费计划足够个人项目使用
- **自动部署**：如果通过GitHub/GitLab集成，代码变更会自动触发部署
- **高可靠性**：Cloudflare的网络具有高可用性和容错能力
